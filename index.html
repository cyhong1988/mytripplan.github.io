<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 法國酒莊聖誕跨年之旅</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8f9fa; }
        .day-card { display: none; }
        .day-card.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .sync-loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .edit-input { border: 1px solid #ddd; border-radius: 6px; padding: 8px; font-size: 0.9rem; outline-color: #f43f5e; background: white; width: 100%; }
        .pin-active { color: #f43f5e !important; transform: rotate(-45deg); }
    </style>
</head>
<body class="bg-slate-50">

    <div class="flex h-screen overflow-hidden">
        <aside class="sidebar w-20 md:w-64 bg-slate-900 text-white flex flex-col">
            <div class="p-4 text-center border-b border-slate-700">
                <i class="fas fa-wine-glass-alt text-2xl text-red-400"></i>
                <span class="hidden md:inline block mt-2 font-bold tracking-widest text-sm uppercase">France 2025</span>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <button onclick="showDay('overview')" class="w-full flex items-center p-4 hover:bg-slate-800 transition">
                    <i class="fas fa-home w-8"></i><span class="hidden md:inline ml-2 text-sm">行程總覽</span>
                </button>
                <div id="dayLinks"></div>
            </nav>
            <button onclick="syncData()" class="p-4 text-[10px] text-blue-400 hover:text-white uppercase border-t border-slate-800 text-center flex flex-col items-center">
                <i id="syncIcon" class="fas fa-sync-alt mb-1"></i>
                <span class="hidden md:inline">同步雲端資料</span>
            </button>
        </aside>

        <main class="flex-1 overflow-y-auto relative bg-white">
            <header class="sticky top-0 bg-white/80 backdrop-blur-md z-10 px-6 py-4 border-b flex justify-between items-center">
                <h2 id="currentDayTitle" class="text-lg font-bold text-slate-800">載入中...</h2>
                <div class="text-[10px] text-slate-400" id="saveStatus">就緒</div>
            </header>

            <div id="contentArea" class="p-4 md:p-8 max-w-4xl mx-auto">
                <div id="overview" class="day-card active text-center py-20">
                    <i class="fas fa-spinner sync-loading text-3xl text-slate-300"></i>
                    <p class="mt-4 text-slate-500">正在同步雲端資料...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 【重要】請在此處貼上你的 Google Apps Script Web App 網址
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxaqVKc56vf2-B7WCsiwy9sf7ADtM9YJEyhAjLzqJjAEyKjXqyiGcdBNqYgdfgXX0t_HQ/exec"; 

        let tripData = [];

        // 從雲端讀取資料
        async function syncData() {
            const icon = document.getElementById('syncIcon');
            const status = document.getElementById('saveStatus');
            icon.classList.add('sync-loading');
            status.innerText = '同步中...';

            try {
                const response = await fetch(SCRIPT_URL);
                const cloudData = await response.json();
                
                if (cloudData && cloudData.length > 0) {
                    tripData = cloudData;
                    renderUI();
                    status.innerText = '雲端同步成功';
                } else {
                    // 如果雲端沒資料，就初始化
                    status.innerText = '雲端無資料';
                }
            } catch (e) {
                console.error(e);
                status.innerText = '同步失敗，請檢查網址';
            } finally {
                icon.classList.remove('sync-loading');
            }
        }

        // 儲存到雲端
        async function saveToCloud() {
            const status = document.getElementById('saveStatus');
            status.innerText = '儲存中...';
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(tripData),
                    mode: 'no-cors' // Google Apps Script 要求 no-cors 或特殊處理
                });
                status.innerText = '已儲存至雲端';
            } catch (e) {
                status.innerText = '儲存失敗';
            }
        }

        function renderUI() {
            const linkContainer = document.getElementById('dayLinks');
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div id="overview" class="day-card active">
                    <div class="bg-gradient-to-r from-red-500 to-rose-600 rounded-2xl p-6 text-white mb-8 shadow-lg">
                        <h1 class="text-2xl font-bold mb-2">二訪法國行程同步版</h1>
                        <p class="opacity-90 font-mono text-sm">多裝置即時同步</p>
                    </div>
                    <div id="pinnedItemsContainer" class="grid gap-3"></div>
                </div>`;
            linkContainer.innerHTML = '';

            tripData.forEach((day, dIdx) => {
                const link = document.createElement('button');
                link.onclick = () => showDay(`day-${dIdx}`);
                link.className = "w-full p-4 hover:bg-slate-800 transition flex flex-col items-center border-l-4 border-transparent hover:border-red-400";
                link.innerHTML = `<span class="text-[10px] opacity-50">${day.date}</span><span class="text-xs font-bold text-white">D${dIdx+1}</span>`;
                linkContainer.appendChild(link);

                const card = document.createElement('div');
                card.id = `day-${dIdx}`;
                card.className = "day-card space-y-4";
                
                let itemsHtml = `<div class="space-y-3">`;
                day.items.forEach((item, iIdx) => {
                    itemsHtml += `
                        <div class="flex flex-col p-3 bg-white border-b">
                            <div id="disp-${dIdx}-${iIdx}" class="flex items-center justify-between gap-2">
                                <div class="flex gap-3 items-center overflow-hidden">
                                    <span class="font-mono font-bold text-slate-400 w-12 text-xs shrink-0">${item.time}</span>
                                    <span class="text-sm truncate">${item.text}</span>
                                    ${item.map ? `<a href="${item.map}" target="_blank" class="text-blue-500"><i class="fas fa-map-marker-alt"></i></a>` : ''}
                                </div>
                                <div class="flex items-center gap-1 shrink-0">
                                    <button onclick="togglePin(${dIdx}, ${iIdx})" id="pin-icon-${dIdx}-${iIdx}" class="p-2 ${item.pinned ? 'pin-active' : 'text-slate-100'}">
                                        <i class="fas fa-thumbtack"></i>
                                    </button>
                                    <button onclick="startEdit(${dIdx}, ${iIdx})" class="p-2 text-slate-200"><i class="fas fa-pen text-[10px]"></i></button>
                                </div>
                            </div>
                            <div id="edit-${dIdx}-${iIdx}" class="hidden flex flex-col gap-2 bg-slate-50 p-3 rounded-xl mt-2 border border-red-100">
                                <input type="text" id="in-time-${dIdx}-${iIdx}" class="edit-input" value="${item.time}">
                                <input type="text" id="in-text-${dIdx}-${iIdx}" class="edit-input" value="${item.text}">
                                <input type="text" id="in-map-${dIdx}-${iIdx}" class="edit-input" value="${item.map || ''}" placeholder="Map URL">
                                <div class="flex justify-end gap-2 mt-2">
                                    <button onclick="saveEdit(${dIdx}, ${iIdx})" class="bg-slate-900 text-white text-xs px-4 py-2 rounded-lg">儲存並同步</button>
                                </div>
                            </div>
                        </div>`;
                });
                card.innerHTML = `<h2 class="text-xl font-black mb-4">${day.date} ${day.title}</h2>${itemsHtml}</div>`;
                contentArea.appendChild(card);
            });
            updatePinnedList();
            showDay('overview');
        }

        function togglePin(dIdx, iIdx) {
            tripData[dIdx].items[iIdx].pinned = !tripData[dIdx].items[iIdx].pinned;
            saveEditToMemory();
        }

        async function saveEdit(dIdx, iIdx) {
            tripData[dIdx].items[iIdx].time = document.getElementById(`in-time-${dIdx}-${iIdx}`).value;
            tripData[dIdx].items[iIdx].text = document.getElementById(`in-text-${dIdx}-${iIdx}`).value;
            tripData[dIdx].items[iIdx].map = document.getElementById(`in-map-${dIdx}-${iIdx}`).value;
            saveEditToMemory();
        }

        function saveEditToMemory() {
            renderUI();
            saveToCloud();
        }

        function updatePinnedList() {
            const container = document.getElementById('pinnedItemsContainer');
            if(!container) return;
            container.innerHTML = '';
            tripData.forEach((day, dIdx) => {
                day.items.forEach((item) => {
                    if (item.pinned) {
                        const div = document.createElement('div');
                        div.className = "flex items-center gap-3 p-3 bg-white border rounded-xl shadow-sm";
                        div.innerHTML = `<div class="text-[9px] bg-red-50 text-red-500 font-bold px-2 py-1 rounded shrink-0">${day.date}</div><div class="text-sm flex-1 truncate font-medium">${item.text}</div>`;
                        container.appendChild(div);
                    }
                });
            });
        }

        function showDay(id) {
            document.querySelectorAll('.day-card').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const idx = id.split('-')[1];
            document.getElementById('currentDayTitle').innerText = tripData[idx] ? `${tripData[idx].date} 行程` : "總覽";
        }

        function startEdit(dIdx, iIdx) {
            document.getElementById(`disp-${dIdx}-${iIdx}`).classList.add('hidden');
            document.getElementById(`edit-${dIdx}-${iIdx}`).classList.remove('hidden');
        }

        // 初始化：先嘗試同步資料
        syncData();
    </script>
</body>
</html>
