<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 法國酒莊聖誕跨年之旅</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8f9fa; }
        .day-card { display: none; }
        .day-card.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .sync-loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .edit-input { 
            border: 1px solid #e2e8f0; 
            border-radius: 10px; 
            padding: 10px 12px; 
            font-size: 0.95rem; 
            outline: none;
            background: white; 
            width: 100%;
            transition: border-color 0.2s;
        }
        .edit-input:focus { border-color: #f43f5e; }
        
        .time-input-wrapper { width: 140px; }
        .pin-active { color: #f43f5e !important; transform: rotate(-45deg); transition: all 0.2s; }
        .pin-inactive { color: #e2e8f0; }
        .map-icon-btn { color: #3b82f6; background: #eff6ff; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; }
        .label-text { font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 6px; display: flex; align-items: center; gap: 4px; }
    </style>
</head>
<body class="bg-slate-50">

    <div class="flex h-screen overflow-hidden">
        <aside class="sidebar w-20 md:w-64 bg-slate-900 text-white flex flex-col">
            <div class="p-4 text-center border-b border-slate-700">
                <i class="fas fa-wine-glass-alt text-2xl text-red-400"></i>
                <span class="hidden md:inline block mt-2 font-bold tracking-widest text-sm uppercase">France 2025</span>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <button onclick="showDay('overview')" class="w-full flex items-center p-4 hover:bg-slate-800 transition">
                    <i class="fas fa-home w-8 text-rose-400"></i><span class="hidden md:inline ml-2 text-sm font-medium">行程總覽</span>
                </button>
                <div id="dayLinks"></div>
            </nav>
            <button onclick="syncData()" class="p-4 text-[10px] text-blue-400 hover:text-white uppercase border-t border-slate-800 text-center flex flex-col items-center">
                <i id="syncIcon" class="fas fa-sync-alt mb-1"></i>
                <span class="hidden md:inline">同步雲端資料</span>
            </button>
        </aside>

        <main class="flex-1 overflow-y-auto relative bg-white">
            <header class="sticky top-0 bg-white/90 backdrop-blur-md z-10 px-6 py-4 border-b flex justify-between items-center">
                <h2 id="currentDayTitle" class="text-lg font-bold text-slate-800">載入中...</h2>
                <div class="text-[10px] text-slate-400 px-2 py-1 bg-slate-100 rounded" id="saveStatus">就緒</div>
            </header>

            <div id="contentArea" class="p-4 md:p-8 max-w-4xl mx-auto">
                <div id="overview" class="day-card active text-center py-20">
                    <i class="fas fa-spinner sync-loading text-3xl text-slate-300"></i>
                    <p class="mt-4 text-slate-500">正在同步雲端資料...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxaqVKc56vf2-B7WCsiwy9sf7ADtM9YJEyhAjLzqJjAEyKjXqyiGcdBNqYgdfgXX0t_HQ/exec"; 

        let tripData = [];
        let currentActiveTab = 'overview';

        // 新增：排序函式
        function sortTripItems() {
            tripData.forEach(day => {
                day.items.sort((a, b) => a.time.localeCompare(b.time));
            });
        }

        async function syncData() {
            const icon = document.getElementById('syncIcon');
            const status = document.getElementById('saveStatus');
            icon.classList.add('sync-loading');
            status.innerText = '同步中...';

            try {
                const response = await fetch(SCRIPT_URL);
                const cloudData = await response.json();
                if (cloudData && cloudData.length > 0) {
                    tripData = cloudData;
                    sortTripItems(); // 同步後排序
                    renderUI();
                    status.innerText = '同步成功 ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
            } catch (e) {
                status.innerText = '同步失敗';
            } finally {
                icon.classList.remove('sync-loading');
            }
        }

        async function saveToCloud() {
            const status = document.getElementById('saveStatus');
            status.innerText = '儲存中...';
            try {
                // 儲存前確保資料是排序過的
                sortTripItems();
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(tripData), mode: 'no-cors' });
                status.innerText = '已同步至雲端';
            } catch (e) { status.innerText = '存檔失敗'; }
        }

        function renderUI() {
            const linkContainer = document.getElementById('dayLinks');
            const contentArea = document.getElementById('contentArea');
            
            contentArea.innerHTML = `
                <div id="overview" class="day-card ${currentActiveTab === 'overview' ? 'active' : ''}">
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-8 text-white mb-8 shadow-xl relative overflow-hidden">
                        <div class="relative z-10">
                            <h1 class="text-2xl font-black mb-2 tracking-tight">2025 法國之行</h1>
                            <p class="text-slate-400 text-sm font-mono uppercase tracking-widest">Wine & Christmas Trip</p>
                        </div>
                        <i class="fas fa-wine-bottle absolute -right-4 -bottom-4 text-8xl opacity-10 rotate-12"></i>
                    </div>
                    <div class="mb-6 flex items-center gap-2 text-slate-800 font-bold mb-4 px-1">
                        <i class="fas fa-thumbtack text-rose-500"></i>
                        <span>精選釘選清單</span>
                    </div>
                    <div id="pinnedItemsContainer" class="space-y-6"></div>
                </div>`;
            
            linkContainer.innerHTML = '';

            tripData.forEach((day, dIdx) => {
                const link = document.createElement('button');
                link.onclick = () => showDay(`day-${dIdx}`);
                link.className = `w-full p-4 hover:bg-slate-800 transition flex flex-col items-center border-l-4 ${currentActiveTab === 'day-'+dIdx ? 'border-rose-500 bg-slate-800' : 'border-transparent'}`;
                link.innerHTML = `<span class="text-[10px] opacity-40 font-mono">${day.date}</span><span class="text-xs font-bold text-white">D${dIdx+1}</span>`;
                linkContainer.appendChild(link);

                const card = document.createElement('div');
                card.id = `day-${dIdx}`;
                card.className = `day-card space-y-4 ${currentActiveTab === 'day-'+dIdx ? 'active' : ''}`;
                
                let itemsHtml = `<div class="space-y-1">`;
                day.items.forEach((item, iIdx) => {
                    itemsHtml += `
                        <div class="flex flex-col p-4 bg-white hover:bg-slate-50 transition border-b">
                            <div id="disp-${dIdx}-${iIdx}" class="flex items-center justify-between gap-4">
                                <div class="flex gap-4 items-center overflow-hidden">
                                    <span class="font-mono font-black text-slate-300 w-10 text-xs shrink-0">${item.time}</span>
                                    <span class="text-sm font-medium text-slate-700 truncate">${item.text}</span>
                                    ${item.map ? `<a href="${item.map}" target="_blank" class="map-icon-btn"><i class="fas fa-location-arrow"></i></a>` : ''}
                                </div>
                                <div class="flex items-center gap-1 shrink-0">
                                    <button onclick="togglePin(${dIdx}, ${iIdx})" class="p-2 ${item.pinned ? 'pin-active' : 'pin-inactive'}"><i class="fas fa-thumbtack"></i></button>
                                    <button onclick="startEdit(${dIdx}, ${iIdx})" class="p-2 text-slate-200"><i class="fas fa-ellipsis-v text-xs"></i></button>
                                </div>
                            </div>
                            <div id="edit-${dIdx}-${iIdx}" class="hidden space-y-4 bg-slate-50 p-5 rounded-2xl mt-2 border border-slate-200">
                                <div class="time-input-wrapper">
                                    <label class="label-text"><i class="far fa-clock"></i> 時間</label>
                                    <input type="time" id="in-time-${dIdx}-${iIdx}" class="edit-input font-mono" value="${item.time}">
                                </div>
                                <div>
                                    <label class="label-text"><i class="fas fa-pen"></i> 行程細項</label>
                                    <input type="text" id="in-text-${dIdx}-${iIdx}" class="edit-input" value="${item.text}" placeholder="要做什麼呢？">
                                </div>
                                <div>
                                    <label class="label-text"><i class="fas fa-map-marker-alt"></i> 地點連結 (選填)</label>
                                    <input type="text" id="in-map-${dIdx}-${iIdx}" class="edit-input" value="${item.map || ''}" placeholder="貼上 Google Maps 網址">
                                </div>
                                <div class="flex justify-between items-center pt-2">
                                    <button onclick="deleteItem(${dIdx}, ${iIdx})" class="text-red-400 text-xs font-bold hover:text-red-600 transition">刪除項目</button>
                                    <div class="flex gap-3">
                                        <button onclick="renderUI()" class="text-slate-400 text-xs font-bold px-2 py-2">取消</button>
                                        <button onclick="saveEdit(${dIdx}, ${iIdx})" class="bg-slate-900 text-white text-xs px-6 py-2 rounded-xl font-bold">儲存更新</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                });
                card.innerHTML = `
                    <div class="px-1 mb-6">
                        <span class="text-rose-500 font-mono text-xs font-bold uppercase tracking-widest">${day.date}</span>
                        <h2 class="text-2xl font-black text-slate-800">${day.title}</h2>
                    </div>
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">${itemsHtml}</div>
                    <button onclick="addItem(${dIdx})" class="w-full mt-4 py-4 border-2 border-dashed border-slate-200 rounded-3xl text-slate-400 text-sm font-bold hover:border-rose-300 hover:text-rose-500 transition-all">+ 新增行程細項</button>`;
                contentArea.appendChild(card);
            });
            updatePinnedList();
            updateHeaderTitle();
        }

        function updatePinnedList() {
            const container = document.getElementById('pinnedItemsContainer');
            if(!container) return;
            container.innerHTML = '';
            
            let hasPinned = false;
            tripData.forEach((day, dIdx) => {
                const pinnedInDay = day.items.filter(i => i.pinned);
                if (pinnedInDay.length > 0) {
                    hasPinned = true;
                    const dayBox = document.createElement('div');
                    dayBox.className = "bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden";
                    dayBox.innerHTML = `<div class="bg-slate-50 px-4 py-2 text-[10px] font-bold text-slate-400 border-b flex justify-between"><span>${day.date}</span><span>${day.title}</span></div>`;
                    
                    const itemWrap = document.createElement('div');
                    pinnedInDay.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = "flex items-center justify-between p-4 border-b last:border-0";
                        itemDiv.innerHTML = `
                            <div class="flex items-center gap-4 overflow-hidden">
                                <span class="font-mono text-xs text-rose-400 font-bold">${item.time}</span>
                                <span class="text-sm font-bold text-slate-700 truncate">${item.text}</span>
                            </div>
                            <div class="flex gap-2 shrink-0">
                                ${item.map ? `<a href="${item.map}" target="_blank" class="map-icon-btn"><i class="fas fa-map-marker-alt"></i></a>` : ''}
                                <button onclick="showDay('day-${dIdx}')" class="p-2 text-slate-300"><i class="fas fa-chevron-right"></i></button>
                            </div>`;
                        itemWrap.appendChild(itemDiv);
                    });
                    dayBox.appendChild(itemWrap);
                    container.appendChild(dayBox);
                }
            });

            if(!hasPinned) {
                container.innerHTML = `<div class="text-center py-20 bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 text-slate-400 text-sm font-medium">點擊行程旁的圖釘，<br>將重要預約顯示在這裡</div>`;
            }
        }

        function togglePin(dIdx, iIdx) {
            tripData[dIdx].items[iIdx].pinned = !tripData[dIdx].items[iIdx].pinned;
            renderUI();
            saveToCloud();
        }

        function startEdit(dIdx, iIdx) {
            document.getElementById(`disp-${dIdx}-${iIdx}`).classList.add('hidden');
            document.getElementById(`edit-${dIdx}-${iIdx}`).classList.remove('hidden');
        }

        function saveEdit(dIdx, iIdx) {
            tripData[dIdx].items[iIdx].time = document.getElementById(`in-time-${dIdx}-${iIdx}`).value;
            tripData[dIdx].items[iIdx].text = document.getElementById(`in-text-${dIdx}-${iIdx}`).value;
            tripData[dIdx].items[iIdx].map = document.getElementById(`in-map-${dIdx}-${iIdx}`).value;
            
            sortTripItems(); // 儲存後立即重新排序
            renderUI();
            saveToCloud();
        }

        function deleteItem(dIdx, iIdx) {
            if(confirm('確定刪除此行程項目？')) {
                tripData[dIdx].items.splice(iIdx, 1);
                renderUI();
                saveToCloud();
            }
        }

        function addItem(dIdx) {
            // 新增一個 09:00 的空白項目
            tripData[dIdx].items.push({time: "09:00", text: "", pinned: false, map: ""});
            sortTripItems(); // 排序確保位置正確
            
            // 找出排序後該新項目的 index (因為排序後位置可能變了)
            const newIdx = tripData[dIdx].items.findIndex(i => i.text === "" && i.time === "09:00");
            
            renderUI();
            saveToCloud();
            startEdit(dIdx, newIdx);
        }

        function showDay(id) {
            currentActiveTab = id;
            document.querySelectorAll('.day-card').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            renderUI();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateHeaderTitle() {
            const titleEl = document.getElementById('currentDayTitle');
            if (currentActiveTab === 'overview') {
                titleEl.innerText = "行程總覽";
            } else if (tripData.length > 0) {
                const idx = currentActiveTab.split('-')[1];
                titleEl.innerText = tripData[idx].date + " 行程規劃";
            }
        }

        syncData();
    </script>
</body>
</html>
